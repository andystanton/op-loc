<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <title>Optimum Locum</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        @import url(http://fonts.googleapis.com/css?family=Lato:300,400,700);
        body {
            background-color: #e6e6e6;
            font-size: 100%;
            font-family: 'Lato', sans-serif;
            font-weight: 400;
        }

        div, textarea, input {
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
        }
        form {
            max-width: 100%;
            display: block;
        }
        form input {
            margin: none;
            border: 1px solid #cccccc;
            padding: 6px 10px;
            color: #555555;
            font-size: 1em;
            width: 100%;
        }
    </style>
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
    </style>
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAaXGkVaBCl0l_jmEDpY3m2bfriFmZ23js">
    </script>
    <script type="text/javascript">
        var map;
      function initialize() {
        var mapOptions = {
          center: new google.maps.LatLng(51.40033, -1.32059),
          zoom: 8
        };
        map = new google.maps.Map(document.getElementById("map-canvas"),
            mapOptions);
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
</head>
<body ng-controller="myController">
    <script type="text/javascript" src="bower_components/angular/angular.min.js"></script>
    <script type="text/javascript">
        var app = angular.module('myApp', []);

        app.config(['$httpProvider', function($httpProvider) {
            $httpProvider.defaults.useXDomain = true;
            delete $httpProvider.defaults.headers.common['X-Requested-With'];
        }])

        app.service('LocationFinder', function($q, $http){
            var API_URL = '/find/name/';
            this.findByName = function(name) {
                var deferred = $q.defer();
                if (name.length >= 3) {
                    $http.get(API_URL + name).then(function(locations) {
                        var _locations = {};
                        var locations = locations.data;
                        for(var i = 0, len = locations.length; i < len; i++) {
                            _locations[locations[i].name] = "(" + locations[i].latlong.latitude + ", " + locations[i].latlong.longitude + ")";
                        }
                        deferred.resolve(_locations);
                    }, function() {
                        deferred.reject(arguments);
                    });
                } else {
                    deferred.reject(arguments);
                }
                return deferred.promise;
            }
        })

        app.controller('myController', function($scope, LocationFinder) {
            $scope.selectedLocation = null;
            $scope.locations = {};
            $scope.findByName = function(name) {
                LocationFinder.findByName(name).then(function(locations) {
                    $scope.locations = locations;
                });
            }
        })

        app.directive('keyboardPoster', function($parse, $timeout){
            var DELAY_TIME_BEFORE_POSTING = 0;
            return function(scope, elem, attrs) {

                var element = angular.element(elem)[0];
                var currentTimeout = null;

                element.oninput = function() {
                    var model = $parse(attrs.postFunction);
                    var poster = model(scope);

                    if(currentTimeout) {
                        $timeout.cancel(currentTimeout)
                    }

                    currentTimeout = $timeout(function() {
                        poster(angular.element(element).val());
                    }, DELAY_TIME_BEFORE_POSTING)
                }
            }
        })
    </script>
    <form action="#" onsubmit="lookat(); return false">
        <input type="text" 
               keyboard-poster 
               post-function="findByName" 
               name="locationSearch"
               placeholder="Start typing" 
               list="_locations"
               id="locationInput"/>
        <datalist id="_locations">
            <select style="display: none;"
                    id="_select"
                    name="_select"
                    ng-model='selectedLocation'
                    ng-options='k as v for (k,v) in locations'>
            </select>
        </datalist>
    </form>
    <script type="text/javascript">
        var marker;
        function lookat() {
            var title = document.getElementById('locationInput');
            var selectbox = document.getElementById('_select');
            for (var i=0; i<selectbox.options.length; i++) {
                var selopt = selectbox.options[i];

                if (selopt.value == title.value) {
                    if (marker != undefined) marker.setMap(null);
                    var coordText = selopt.text;
                    coordText = coordText.substr(1, coordText.length-2);
                    console.log(coordText);
                    var coords = coordText.split(",");
                    var lat = coords[0].trim();
                    var lng = coords[1].trim();
                    console.log("got coords: " + lat + ", " + lng);

                     marker = new google.maps.Marker({
                          position: new google.maps.LatLng(lat,lng),
                          map: map,
                          title: selopt.value
                      });
                }
            }
        }

        document.getElementById('locationInput').addEventListener('input', function () {
           console.log('changed');
        });
    </script>
    <div id="map-canvas"/>
</body>
</html>